<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ESP32 Robot Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: #111;
  color: #eee;
  font-family: sans-serif;
  overflow: hidden;
  overscroll-behavior: none;
  touch-action: none;
}

/* ===== CAMERA BACKGROUND ===== */
#cameraBG {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none;
  z-index: 0;
}

/* ===== TOP BAR ===== */
#top {
  padding: 12px;
  text-align: center;
  position: relative;
  z-index: 10;
}

#menuBtn {
  position: absolute;
  left: 12px;
  top: 12px;
  font-size: 24px;
  background: none;
  border: none;
  color: #eee;
}

#fullscreenBtn {
  position: absolute;
  right: 12px;
  top: 12px;
  font-size: 20px;
  background: none;
  border: none;
  color: #eee;
}

#status {
  font-size: 14px;
  margin-top: 4px;
}

#battery {
  margin-top: 6px;
  font-size: 16px;
}

/* ===== JOYSTICK ===== */
#joysticks {
  position: fixed;
  right: 20px;
  bottom: 20px;
  z-index: 10;
}

.joy {
  width: 180px;
  height: 180px;
  background: rgba(255,255,255,0.04);
  border-radius: 50%;
  position: relative;
  touch-action: none;
  backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,0.12);
}

.knob {
  width: 70px;
  height: 70px;
  background: rgba(255,255,255,0.3);
  border-radius: 50%;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  border: 1px solid rgba(255,255,255,0.5);
}

/* ===== MODAL ===== */
#overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  z-index: 1000;
}

#settings {
  position: fixed;
  top: 50%;
  left: 50%;
  width: 280px;
  background: #1e1e1e;
  border-radius: 10px;
  padding: 16px;
  transform: translate(-50%, -50%);
  display: none;
  z-index: 1001;
}

.setting {
  margin-bottom: 14px;
}

.setting label {
  font-size: 14px;
  display: block;
  margin-bottom: 6px;
}

#settings button {
  width: 100%;
  padding: 8px;
  background: #333;
  border: none;
  color: #eee;
  border-radius: 6px;
}
</style>
</head>

<body>

<video id="cameraBG" autoplay muted playsinline></video>

<div id="overlay" onclick="closeSettings()"></div>

<div id="settings">
  <h2 style="text-align:center">âš™ Settings</h2>

  <div class="setting">
    <label>Max Speed</label>
    <input id="speedSlider" type="range" min="0.2" max="1" step="0.1">
  </div>

  <div class="setting">
    <label>
      <input id="invertSteeringChk" type="checkbox">
      Invert Steering
    </label>
  </div>

  <div class="setting">
    <label>
      <input id="invertThrottleChk" type="checkbox">
      Invert Throttle
    </label>
  </div>

  <div class="setting">
    <label>
      <input id="cameraToggle" type="checkbox">
      Camera Background
    </label>
  </div>

  <button onclick="closeSettings()">Close</button>
</div>

<div id="top">
  <button id="menuBtn" onclick="openSettings()">â˜°</button>
  <button onclick="connect()">ðŸ”— Connect</button>
  <button id="fullscreenBtn" onclick="toggleFullscreen()">â›¶</button>
  <div id="status">Disconnected</div>
  <div id="battery">V: --.- V | I: ---.- mA</div>
</div>

<div id="joysticks">
  <div class="joy" id="joyDrive">
    <div class="knob"></div>
  </div>
</div>

<script>
/* ================= BLE CONFIG ================= */
const SERVICE='12345678-1234-1234-1234-1234567890ab';
const RX='12345678-1234-1234-1234-1234567890ac';
const TX='12345678-1234-1234-1234-1234567890ad';

let device,rxChar,txChar;
let throttle=0,steering=0,rxBuffer="";
let cameraStream=null;

/* ================= SETTINGS STATE ================= */
let settings = {
  maxSpeed: 1.0,
  invertSteering: false,
  invertThrottle: false,
  cameraBG: false
};

/* ================= SETTINGS LOAD/SAVE ================= */
function loadSettings() {
  Object.assign(settings, JSON.parse(localStorage.getItem("settings") || "{}"));

  speedSlider.value = settings.maxSpeed;
  invertSteeringChk.checked = settings.invertSteering;
  invertThrottleChk.checked = settings.invertThrottle;
  cameraToggle.checked = settings.cameraBG;

  if (settings.cameraBG) toggleCamera(true);
}

function saveSettings() {
  localStorage.setItem("settings", JSON.stringify(settings));
}

/* ================= UI EVENTS ================= */
speedSlider.oninput = e => {
  settings.maxSpeed = parseFloat(e.target.value);
  saveSettings();
};

invertSteeringChk.onchange = e => {
  settings.invertSteering = e.target.checked;
  saveSettings();
};

invertThrottleChk.onchange = e => {
  settings.invertThrottle = e.target.checked;
  saveSettings();
};

cameraToggle.onchange = e => {
  toggleCamera(e.target.checked);
};

/* ================= BLE ================= */
async function connect(){
  device=await navigator.bluetooth.requestDevice({
    filters:[{name:'ESP32_ROBOT-ble'}],
    optionalServices:[SERVICE]
  });
  const server=await device.gatt.connect();
  const service=await server.getPrimaryService(SERVICE);
  rxChar=await service.getCharacteristic(RX);
  txChar=await service.getCharacteristic(TX);
  await txChar.startNotifications();
  txChar.addEventListener('characteristicvaluechanged',onNotify);
  status.textContent="Connected";
}

function onNotify(e){
  rxBuffer+=new TextDecoder().decode(e.target.value);
  if(rxBuffer.includes('\n')){
    handleStatus(rxBuffer.trim());
    rxBuffer="";
  }
}

/* ================= MOTOR LOOP ================= */
setInterval(()=>{
  if(!rxChar) return;
  const L=(throttle-steering)*settings.maxSpeed;
  const R=(throttle+steering)*settings.maxSpeed;
  rxChar.writeValue(new TextEncoder().encode(
    `motor ${Math.round(L*255)},${Math.round(R*255)}\n`
  ));
},20);

/* ================= STATUS ================= */
function handleStatus(msg){
  const v=msg.match(/V=([\d.]+)/);
  const i=msg.match(/I=([\d.]+)/);
  if(v&&i){
    battery.textContent=
      `V: ${(+v[1]).toFixed(2)} V | I: ${(+i[1]).toFixed(1)} mA`;
  }
}

/* ================= RELATIVE JOYSTICK ================= */
function setupJoystick(el) {
  const knob = el.querySelector('.knob');
  const r = el.clientWidth/2;
  const kr = knob.clientWidth/2;
  const maxDist = r-kr;
  let active=false, sx=0, sy=0;

  function update(dx,dy){
    const d=Math.min(maxDist,Math.hypot(dx,dy));
    const a=Math.atan2(dy,dx);
    const px=Math.cos(a)*d, py=Math.sin(a)*d;
    knob.style.transform=`translate(${px}px,${py}px) translate(-50%,-50%)`;
    steering = settings.invertSteering ? px/maxDist : -px/maxDist;
    throttle = settings.invertThrottle ? py/maxDist : -py/maxDist;
  }

  el.addEventListener('pointerdown',e=>{
    el.setPointerCapture(e.pointerId);
    active=true;
    sx=e.clientX; sy=e.clientY;
    update(0,0);
  });

  el.addEventListener('pointermove',e=>{
    if(active) update(e.clientX-sx,e.clientY-sy);
  });

  el.addEventListener('pointerup',()=>{
    active=false;
    knob.style.transform='translate(-50%,-50%)';
    throttle=steering=0;
  });
}

/* ================= CAMERA ================= */
async function toggleCamera(en){
  settings.cameraBG=en;
  cameraToggle.checked=en;
  saveSettings();

  if(en){
    try{
      cameraStream=await navigator.mediaDevices.getUserMedia({
        video:{facingMode:{ideal:"environment"}},audio:false
      });
      cameraBG.srcObject=cameraStream;
      cameraBG.style.display="block";
    }catch{
      settings.cameraBG=false;
      cameraToggle.checked=false;
      saveSettings();
    }
  }else{
    cameraBG.style.display="none";
    cameraStream?.getTracks().forEach(t=>t.stop());
    cameraStream=null;
  }
}

/* ================= UI ================= */
function toggleFullscreen(){
  document.fullscreenElement ?
    document.exitFullscreen() :
    document.documentElement.requestFullscreen();
}
function openSettings(){ overlay.style.display=settingsDiv.style.display="block"; }
function closeSettings(){ overlay.style.display=settingsDiv.style.display="none"; }

/* ================= INIT ================= */
const settingsDiv=document.getElementById("settings");
setupJoystick(joyDrive);
loadSettings();
</script>

</body>
</html>
